name: Generate Go proto files

on:
  push:
    paths:
      - '**/proto/**/*.proto'

jobs:
  generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦git diffã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler

      - name: Install protoc-gen-go and protoc-gen-go-grpc
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

      - name: Get changed proto files
        id: changed-protos
        run: |
          echo "ğŸ” Detecting changed proto files from push..."
          echo "ğŸ”§ Debug info:"
          echo "   Event name: ${{ github.event_name }}"
          echo "   Before SHA: ${{ github.event.before }}"
          echo "   Current SHA: ${{ github.sha }}"
          echo "   Ref: ${{ github.ref }}"

          # pushã•ã‚ŒãŸå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºå®Ÿã«å–å¾—
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "ğŸ“‹ Push event detected"

            # è¤‡æ•°ã®æ–¹æ³•ã‚’é †ç•ªã«è©¦ã™
            all_changed=""

            # æ–¹æ³•1: beforeã¨currentã®å·®åˆ†ï¼ˆé€šå¸¸ã®pushï¼‰
            if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && git cat-file -e "${{ github.event.before }}" 2>/dev/null; then
              echo "   Method 1: Using before..current range"
              all_changed=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} 2>/dev/null || echo "")
            fi

            # æ–¹æ³•2: HEAD~1..HEADï¼ˆsingle commit pushï¼‰
            if [ -z "$all_changed" ]; then
              echo "   Method 2: Using HEAD~1..HEAD"
              all_changed=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
            fi

            # æ–¹æ³•3: git showã§HEADã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«
            if [ -z "$all_changed" ]; then
              echo "   Method 3: Using git show"
              all_changed=$(git show --name-only --pretty="" HEAD 2>/dev/null || echo "")
            fi

            echo "ğŸ” All changed files:"
            if [ -n "$all_changed" ]; then
              echo "$all_changed" | sed 's/^/   /'
            else
              echo "   No files changed"
            fi

            # .protoãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
            changed_proto_files=$(echo "$all_changed" | grep '\.proto$' || echo "")
          else
            echo "ğŸ“‹ Non-push event, using HEAD~1..HEAD"
            all_changed=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git show --name-only --pretty="" HEAD)
            echo "ğŸ” All changed files:"
            echo "$all_changed" | sed 's/^/   /'
            changed_proto_files=$(echo "$all_changed" | grep '\.proto$' || echo "")
          fi

          echo "ğŸ“„ Changed proto files:"
          if [ -n "$changed_proto_files" ]; then
            echo "$changed_proto_files" | sed 's/^/   /'
          else
            echo "   No proto files changed"
          fi

          # å¤‰æ›´ã•ã‚ŒãŸprotoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚µãƒ¼ãƒ“ã‚¹åã‚’æŠ½å‡º
          services=()
          if [ -n "$changed_proto_files" ]; then
            while IFS= read -r file; do
              if [ -n "$file" ]; then
                echo "ğŸ” Processing proto file: $file"
                # service/*/proto/**/*.protoã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                if [[ $file == service/*/proto/**/*.proto ]]; then
                  service=$(echo $file | cut -d'/' -f2)
                  echo "   â””â”€â”€ Detected service: $service"

                  # é‡è¤‡ãƒã‚§ãƒƒã‚¯
                  if [[ ! " ${services[@]} " =~ " $service " ]]; then
                    services+=("$service")
                  else
                    echo "   â””â”€â”€ Service $service already added"
                  fi
                else
                  echo "   â””â”€â”€ Skipping (not in service/*/proto/ pattern)"
                fi
              fi
            done <<< "$changed_proto_files"
          fi

          # ã‚µãƒ¼ãƒ“ã‚¹ãƒªã‚¹ãƒˆã‚’ã‚¹ãƒšãƒ¼ã‚¹åŒºåˆ‡ã‚Šã§å‡ºåŠ›
          target_services="${services[*]}"
          echo "ğŸ¯ Target services: ${target_services:-none}"
          echo "target_services=$target_services" >> $GITHUB_OUTPUT

      - name: Generate pb.go
        if: steps.changed-protos.outputs.target_services != ''
        run: |
          target_services="${{ steps.changed-protos.outputs.target_services }}"
          if [ -n "$target_services" ]; then
            echo "ğŸš€ Generating proto files for services: $target_services"
            sh scripts/proto/generate-proto.sh $target_services
            echo "âœ… Proto generation completed"
          else
            echo "â­ï¸  No proto files changed, skipping generation"
          fi

      - name: Check for changes
        id: check-changes
        run: |
          echo "ğŸ” Checking for generated proto file changes..."
          
          # protoç”Ÿæˆã§ä½œã‚‰ã‚Œã‚‹.pb.goãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ãƒã‚§ãƒƒã‚¯
          proto_changes=$(git status --porcelain | grep -E '\.(pb\.go|_grpc\.pb\.go)$' || echo "")
          
          if [ -n "$proto_changes" ]; then
            echo "ğŸ“ Changes detected in generated proto files:"
            echo "$proto_changes" | sed 's/^/   /'
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸŸ° No changes in generated proto files"
            # å¿µã®ãŸã‚å…¨ä½“ã®å¤‰æ›´ã‚‚è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            all_changes=$(git status --porcelain || echo "")
            if [ -n "$all_changes" ]; then
              echo "   (Other changes detected but not proto-related:)"
              echo "$all_changes" | sed 's/^/   /'
            fi
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "ğŸ’¾ Committing and pushing generated proto files..."
          sh scripts/git/git-auto-commit.sh "github-actions[bot]" "github-actions[bot]@users.noreply.github.com"
          echo "ğŸ‰ Changes pushed successfully"