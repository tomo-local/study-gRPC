# Go言語メールサーバー学習計画プラン

> **関連文書**: [ADR-001: 学習用メールサーバーのアーキテクチャ選択](./adr-001-mail-server-architecture.md)

## 概要

Go言語を使用したメールサーバーの構築を通じて、メールプロトコル、ネットワークプログラミング、Dockerコンテナ技術を段階的に学習するための実践的な計画です。

## 学習目標

### 技術目標
- [x] SMTPプロトコルの深い理解
- [x] Go言語でのネットワークプログラミング
- [x] PostgreSQLとの連携実装
- [x] Dockerマルチサービス構成
- [x] DNS/SPF/DKIMの実装経験
- [x] 実際のメール配信（Gmail送信）

### 成果物
- [x] 動作するGo製SMTPサーバー
- [x] PostgreSQL連携の認証システム
- [x] Docker構成ファイル
- [x] 実際のドメインでのメール送信実証

## 前提条件

### 必要な知識
- **Go言語**: 基本的な文法、ゴルーチン、チャネル
- **Docker**: 基本的なコンテナ操作
- **PostgreSQL**: 基本的なSQL操作
- **ネットワーク**: TCP/IP、DNS の基礎知識

### 開発環境
```bash
# 必要なツール
- Go 1.19+
- Docker & Docker Compose
- PostgreSQL クライアント
- Git
- テキストエディタ/IDE
```

## 学習フェーズ

## Phase 1: ローカル開発環境構築 【1-2週間】

### 🎯 目標
ローカル環境で基本的なSMTPサーバーを構築し、内部テストを実施

### 📋 タスク

#### Week 1: 環境セットアップとプロトタイプ
- [ ] **Day 1-2: プロジェクト初期化**
  ```bash
  mkdir mail-server-go && cd mail-server-go
  go mod init mail-server-go
  ```
  - Go modules の初期化
  - プロジェクト構造の作成
  - 基本的な Dockerfile の作成

- [ ] **Day 3-4: PostgreSQL環境構築**
  - Docker Compose での PostgreSQL 起動
  - データベーススキーマの作成
  - テストデータの投入

- [ ] **Day 5-7: 基本SMTP実装**
  - `github.com/emersion/go-smtp` の実装
  - 基本的な認証機能
  - ローカルメール送信テスト

#### Week 2: 機能拡張と統合
- [ ] **Day 8-10: 認証システム強化**
  - PostgreSQL との認証連携
  - パスワードハッシュ化
  - ユーザー管理機能

- [ ] **Day 11-12: Docker統合**
  - Docker Compose での全体構成
  - コンテナ間通信の確立
  - 環境変数での設定管理

- [ ] **Day 13-14: テストとデバッグ**
  - 既存アプリからの送信テスト
  - ログ出力の改善
  - エラーハンドリングの追加

### 📦 成果物
- 動作するローカルSMTPサーバー
- PostgreSQL連携の認証システム
- Docker Compose設定
- 基本的なテストスイート

### 💰 コスト
**0円**（ローカル環境のみ）

---

## Phase 2: 実ドメイン環境構築 【2-3週間】

### 🎯 目標
実際のドメインを取得し、DNS設定を学習。クラウド環境でのデプロイを実施

### 📋 タスク

#### Week 3: ドメイン取得とDNS設定
- [ ] **Day 15-16: ドメイン取得**
  - 学習用ドメインの選定・取得
  - DNSプロバイダーの選択
  - 基本的なDNSレコード設定

- [ ] **Day 17-19: クラウド環境セットアップ**
  - VPS/クラウドサーバーの選定
  - サーバーインスタンスの作成
  - セキュリティグループ/ファイアウォール設定

- [ ] **Day 20-21: DNS詳細設定**
  ```dns
  # 設定例
  MX    your-domain.com.  10 mail.your-domain.com.
  A     mail.your-domain.com.  YOUR_SERVER_IP
  TXT   your-domain.com.  "v=spf1 ip4:YOUR_SERVER_IP ~all"
  ```

#### Week 4: サーバーデプロイと設定
- [ ] **Day 22-24: アプリケーションデプロイ**
  - クラウドサーバーへのデプロイ
  - Docker環境の構築
  - SSL証明書の取得（Let's Encrypt）

- [ ] **Day 25-26: 設定調整**
  - 実ドメインでの設定変更
  - ポート設定（25, 587, 465）
  - ログ監視の設定

- [ ] **Day 27-28: 内部テスト**
  - ドメイン間メール送信テスト
  - パフォーマンステスト
  - セキュリティチェック

#### Week 5: 高度なDNS設定
- [ ] **Day 29-31: DKIM実装**
  ```go
  // DKIM署名の実装
  import "github.com/emersion/go-msgauth/dkim"
  ```
  - DKIMキーペアの生成
  - DNS TXTレコードの設定
  - Go実装での署名処理

- [ ] **Day 32-35: 追加セキュリティ**
  - DMARC ポリシーの設定
  - リバースDNS（rDNS）の設定
  - レート制限の実装

### 📦 成果物
- 実ドメインで動作するメールサーバー
- 完全なDNS設定（MX, SPF, DKIM, DMARC）
- クラウド環境でのDocker構成
- SSL/TLS対応

### 💰 コスト
- **ドメイン**: 500-1,000円/年
- **VPS**: 500-1,000円/月
- **SSL証明書**: 0円（Let's Encrypt）

---

## Phase 3: Gmail送信実装 【1-2週間】

### 🎯 目標
実際にGmailへのメール送信を実現し、メール配信の課題と解決策を学習

### 📋 タスク

#### Week 6: Gmail送信準備
- [ ] **Day 36-37: レピュテーション準備**
  - IPアドレスのウォームアップ計画
  - 送信量の段階的増加
  - 配信可能性の監視設定

- [ ] **Day 38-39: 送信最適化**
  - メールヘッダーの最適化
  - バウンス処理の実装
  - 再送ロジックの実装

- [ ] **Day 40-42: Gmail送信テスト**
  - 初回Gmail送信実験
  - スパムフィルター回避の調整
  - 配信結果の分析

#### Week 7: 運用と監視（オプション）
- [ ] **Day 43-45: 監視システム**
  - 配信ログの分析
  - メトリクス収集
  - アラート設定

- [ ] **Day 46-49: トラブルシューティング**
  - 配信失敗の原因分析
  - ブラックリストチェック
  - 改善策の実装

### 📦 成果物
- Gmail送信可能なメールサーバー
- 配信監視システム
- トラブルシューティングガイド

### 💰 追加コスト
なし（Phase 2の環境を継続使用）

---

## 週次チェックリスト

### 毎週の振り返り項目
- [ ] 今週の学習目標は達成できたか？
- [ ] 技術的な課題とその解決策は何だったか？
- [ ] 次週に向けての準備は整っているか？
- [ ] 予算は予定内に収まっているか？

### 成果確認方法
```bash
# 各フェーズでの動作確認コマンド例
# Phase 1
docker-compose up -d
telnet localhost 2525

# Phase 2
dig MX your-domain.com
openssl s_client -connect mail.your-domain.com:587

# Phase 3
# 実際のGmail送信テスト
```

## 予想される課題と対策

### 技術的課題
| 課題 | 対策 |
|------|------|
| SMTP認証の実装 | `go-smtp`の例を参考に段階的実装 |
| PostgreSQL接続エラー | 接続文字列とネットワーク設定の確認 |
| DNS伝播の遅延 | nslookup での確認、最大48時間待機 |
| Gmail送信でスパム判定 | SPF/DKIM/DMARC の正確な設定 |

### 学習上の課題
| 課題 | 対策 |
|------|------|
| Go言語の理解不足 | 並行して Go の基礎学習 |
| ネットワーク知識不足 | TCP/IP、DNS の復習 |
| デバッグの困難さ | 詳細なログ出力の実装 |
| 時間不足 | フェーズを分割して段階的実施 |

## リソース

### 必須参考資料
- [RFC 5321 - SMTP](https://tools.ietf.org/html/rfc5321)
- [go-smtp Documentation](https://github.com/emersion/go-smtp)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)

### 推奨学習サイト
- Go by Example: https://gobyexample.com/
- Docker公式チュートリアル
- DNS基礎学習リソース

### コミュニティ
- Go Slack コミュニティ
- Docker フォーラム
- メールサーバー管理者向けフォーラム

## 成功指標

### Phase 1 完了時
- [x] ローカル環境でメール送信が動作する
- [x] PostgreSQL認証が機能する
- [x] Docker構成が正しく動作する

### Phase 2 完了時
- [x] 実ドメインでメールサーバーが動作する
- [x] DNS設定が正しく反映されている
- [x] SSL/TLS接続が可能

### Phase 3 完了時
- [x] Gmailに正常にメール送信できる
- [x] SPF/DKIM検証がパスする
- [x] スパム判定を回避できる

## 次のステップ

学習完了後の発展的な取り組み：
- IMAPサーバーの実装（受信機能）
- Webmail インターフェースの開発
- 高可用性構成の実装
- メール分析・統計機能の追加

---

**開始日**: ________
**目標完了日**: ________
**実際の完了日**: ________

> 💡 **ヒント**: 無理をせず、各フェーズでしっかりと理解を深めてから次に進むことが重要です。
