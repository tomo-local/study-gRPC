# ADR-001: 学習用メールサーバーのアーキテクチャ選択

## ステータス
承認済み

## 要約
学習目的でのメールサーバー構築において、既存ソリューション（Postfix/Dovecot）ではなく、Go言語による自作実装アプローチを採用する。

## コンテキスト

### 背景
- 学習目的でメールサーバーの構築を行う
- 既存Webアプリケーションからのメール送信機能が必要
- アカウント作成時の確認メール送信機能をテストしたい
- Docker環境での構築を前提とする
- PostgreSQLの使用が要件として決まっている

### 制約
- 学習用途のため、本番環境での使用は想定しない
- ローカル開発環境での動作を前提とする
- セキュリティ要件は最小限に抑える

### 目標
- メールプロトコル（SMTP/IMAP）の深い理解を得る
- ネットワークプログラミングのスキル向上
- Go言語でのサーバーアプリケーション開発経験

## 検討した選択肢

### 選択肢1: 既存メールサーバー（Postfix + Dovecot）
**メリット:**
- 実績豊富で安定している
- セキュリティ対策が充実
- 豊富なドキュメントとコミュニティサポート

**デメリット:**
- 設定が複雑で学習効果が限定的
- ブラックボックス的で内部動作の理解が困難
- 学習目的には過度にエンタープライズ向け

### 選択肢2: Go言語による自作実装（採用）
**メリット:**
- プロトコルレベルでの深い理解が可能
- Go言語の並行処理・ネットワークプログラミング学習
- 必要な機能のみを実装できる
- 軽量で高速な実行が可能
- 豊富なライブラリエコシステム

**デメリット:**
- 開発工数が大きい
- セキュリティリスクの可能性
- 本番環境には不適切

### 選択肢3: Python/Node.js による実装
**メリット:**
- 短期間での実装が可能
- 豊富なライブラリ

**デメリット:**
- パフォーマンスの制約
- Go言語学習の機会を逸する

## 決定

**Go言語による自作メールサーバー実装を採用する**

### 決定理由
1. **学習効果の最大化**: プロトコルレベルでの理解が得られ、ネットワークプログラミングスキルが向上する
2. **技術スタック統一**: 既存システムでGoを使用している場合の一貫性
3. **パフォーマンス**: Go言語の軽量・高速実行による学習環境の快適性
4. **柔軟性**: 必要な機能のみを段階的に実装可能

## 結果

### アーキテクチャ概要
```
┌─────────────────┐    SMTP     ┌──────────────────┐
│   Webアプリ     │ ─────────→ │  Go SMTP Server  │
└─────────────────┘             └──────────────────┘
                                          │
                                          ▼
                                ┌──────────────────┐
                                │   PostgreSQL     │
                                │  (認証・ユーザー) │
                                └──────────────────┘
```

### 技術スタック
- **言語**: Go
- **SMTP実装**: `github.com/emersion/go-smtp`
- **IMAP実装**: `github.com/emersion/go-imap`（Phase 2）
- **データベース**: PostgreSQL
- **ORM**: `gorm.io/gorm`
- **コンテナ**: Docker & Docker Compose

### 実装フェーズ
**Phase 1: SMTP送信サーバー**
- 基本的なSMTP機能
- PostgreSQL認証連携
- 既存アプリからのメール送信

**Phase 2: IMAP受信サーバー（オプション）**
- メール受信・保存機能
- メールボックス管理

### 除外する機能
- Webmailインターフェース
- 複雑なセキュリティ設定
- エンタープライズ向け機能

## 影響

### ポジティブな影響
- Go言語のネットワークプログラミングスキル習得
- メールプロトコルの深い理解
- PostgreSQL連携の実装経験
- Docker マルチサービス構成の学習

### ネガティブな影響・リスク
- 開発期間の延長
- セキュリティホールの可能性
- 本番環境での使用制限

### 軽減策
- 段階的な実装でリスクを最小化
- 既存ライブラリの活用でセキュリティリスクを軽減
- 学習用途に特化した簡素な設計

## 関連する決定
- データベースとしてPostgreSQLを使用（既決定事項）
- Docker環境での構築（既決定事項）

## 注記
本決定は学習目的に特化したものであり、本番環境での使用は想定していない。

## 参考資料
- [RFC 5321 - SMTP](https://tools.ietf.org/html/rfc5321)
- [RFC 3501 - IMAP](https://tools.ietf.org/html/rfc3501)
- [go-smtp Documentation](https://github.com/emersion/go-smtp)
- [go-imap Documentation](https://github.com/emersion/go-imap)
